---
title: "Data Description"
author: "Carlo Provinciali"
date: "April 20, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(readr)
library(tidyverse)
```


```{r}
biz_city <- read_csv("C:/Users/Carlo/Desktop/EDAV Project/Data/businesses and reviews by city.csv")
```
###Description of Data:
For this project, we decided to use the Yelp Open Dataset, which contains 5,200,000 reviews and information about 174,000 businesses across 11 different metropolitan areas. This dataset provides a number of attributes such as hours of a business, location, star rating of each individual review, and business categories. The data was downloaded in SQL format and imported into a local database for preprocessing. Here's a representation of the schema:
![Yelp Dataset schema](https://s3-media3.fl.yelpcdn.com/assets/srv0/engineering_pages/f4456a01e74a/assets/img/dataset/yelp_dataset_schema.png)

We decided to start our exploration by focusing on the business table. Particularly, we were interested in the distribution of businesses by location and category. Since the initial dataset contains several GBs worth of data, we figured we could find a way to subset if by business location and category to make it more manageable. 

For this purpose, we plotted the distribution of businesses by city along with the number of reviews. We immediately noticed that the distribution of these two variables was not homogeneous across cities; rather a few cities had significantly more reviews and businesses than other (unsurprisingly, these two variables are strongly correlated with each other). 


```{r, fig.height=10}
ggplot(biz_city, aes(NumberOfReviews, reorder(city, NumberOfReviews)))+
  geom_point()+
  scale_x_continuous(breaks = seq(0, 10000000, 100000))+
  ggtitle("Number of Reviews by City")+
  ylab("city")
  
```

```{r}
ggplot(biz_city[1:10,], aes(NumberOfReviews, reorder(city, NumberOfReviews)))+
  geom_point()+
  scale_x_continuous(breaks = seq(0, 10000000, 100000))+
  ggtitle("Number of Reviews by City (top 10)")+
  ylab("city")
```

```{r, fig.height=10}
ggplot(biz_city, aes(NumberOfBusinesses, reorder(city, NumberOfBusinesses)))+
  geom_point()+
  scale_x_continuous(breaks = seq(0, 30000, 2000))+
  ggtitle("Number of Businesses by City")+
  ylab("city")
```
```{r}
ggplot(biz_city[1:10,], aes(NumberOfBusinesses, reorder(city, NumberOfBusinesses)))+
  geom_point()+
  scale_x_continuous(breaks = seq(0, 30000, 2000))+
  ggtitle("Number of Businesses by City (Top 10)")+
  ylab("city")
```

```{r}
ggplot(biz_city, aes(NumberOfBusinesses, NumberOfReviews))+
  geom_point(alpha = 0.5)+
  scale_y_continuous(breaks = seq(0, 10000000, 100000))+
  ggtitle("Number of Reviews vs Number of Business by city")
```


We decided to focus our analysis on one of the cities with the highest number of reviews and businesses. Las Vegas, Phoenix, Toronto, Scottsdale, and Charlotte seemed like good candidates since they were in the top 5 list for both reviews and businesses. 

In order to further narrow down this list, we decide to look more closely at the distribution of categories for businesses. We found out the dataset has 1293 unique categories, and one business might be assigned to more than one categories as the data schema suggests. At this point, our group thought it would be interesting to focus on Restaurants, since this type of businesses seem to have the most review and are fairly popular in the dataset. 

```{r message = FALSE, warning = FALSE}
# read in file with number of restaurants in each city by cuisine
# note: the SQL query for this file included only a particular set of cuisines
restaurants_by_cuisine <- read_csv("C:/Users/Carlo/Desktop/EDAV Project/Data/number of restaurants by cuisine.csv")

# concatenate city and state columns into one column called location
restaurants_by_cuisine <- mutate(restaurants_by_cuisine, location=paste0(city,", ",state)) %>% subset(select=c(5,1:4))

# get number of restaurants for each city
r_by_city <- restaurants_by_cuisine %>% group_by(location) %>%
                    summarize(number= sum(NumberOfRestaurants))

r_by_city_filter <- r_by_city %>% filter(number > 1000)

ggplot(r_by_city_filter, aes(x = reorder(location, number), y = number)) + geom_col() + coord_flip() + ggtitle("Number of Restaurants in Cities with >1000 Restaurants") + xlab("City") + ylab("Number of Restaurants")

```

From the graph above, we though Toronto would be a good option since it has the highest number of restaurants. Although we focused on businesses with the "restaurant" category, after further inspecting the dataset we realized that the most restaurants had additional "category" tags that descibed the type of food or cuisine being served. We wanted to make sure that final choice to have a good variety of different cuisines so we could potentially compare across categories. For this reason, we decided to look at the Gini index of the categories other than "Restaurant" for the restaurants in each city. The Gini index would be higher for cities with a good mix of category labels and lower for cities were many restaurants share the same category.

```{r}
# Calculated weighted gini index for each city (measure of both diversity and quantity of restaurants in a city)

# compute percent of restaurants in each location and category
num_cuisines <- restaurants_by_cuisine %>% group_by(location,category) %>% summarise(count = sum(NumberOfRestaurants, na.rm = TRUE)) %>% mutate(perc = round(count/sum(count),4))

gini <- function(x, na.rm = TRUE) {
  index <- 1 - sum(x**2) 
  return(index)
}

# calculate gini index
num_cuisines <- num_cuisines %>% group_by(location) %>% summarise(gini = gini(perc))

num_cuisines <- num_cuisines[order(-num_cuisines$gini),]
head(num_cuisines, 10)
```

```{r}
# calculate weighted gini index
weighted_gini_city <- plyr::join(r_by_city, num_cuisines, by="location")
weighted_gini_city <- mutate(weighted_gini_city, weighted_gini = gini*number/sum(number))

weighted_gini_city <- weighted_gini_city[order(-weighted_gini_city$weighted_gini),]

head(weighted_gini_city, 10)
```

```{r}
# get cities with top 10 weighted gini index
weighted_gini_city_filter <- weighted_gini_city %>% top_n(10, weighted_gini)

ggplot(weighted_gini_city_filter, aes(x = reorder(location, weighted_gini), y = weighted_gini)) + geom_col() + coord_flip() + ggtitle("Cities with Top 10 Weighted Gini Index") + xlab("City") + ylab("Weighted Gini Index")
```


In order to evaluate the diversity of ethnic cuisines in each cities, we hand-picked a few categories that we thought were the most appropriate to describe a specific regional cuisines (such as Italian, French, Japanese, etc) and compared the distribution of these categories across cities.

```{r}
#visualizing diversity of restaurants in cities with top 10 weighted gini index

top_10_cities <- unique(weighted_gini_city_filter$location)

r_by_city_cuisine <- filter(restaurants_by_cuisine, location %in% top_10_cities)

#refactoring location columns
r_by_city_cuisine$location <- factor(r_by_city_cuisine$location)

ggplot(r_by_city_cuisine, aes(x=category, y=NumberOfRestaurants)) + geom_col() + facet_wrap(~location, scales="free_y", ncol=3) + theme(axis.text.x = element_text(angle=90, hjust=1)) + ggtitle("Cuisines by City") + xlab("City") + ylab("Number of Restaurants")
```

These graphs confirmed that Toronto had the best variety in terms of cuisines so we decided to focus on this city for our main analysis.

##Problems with the data

Once we decided to focus our analysis on restaurants in Toronto and created a subset of the restaurant dataset, we notice two main issues with out data:

###Restaurants might have more than one category
This made the creation of a business dataset that included category or cuisine information difficult as each business would be represented multiple times for each one of its categories. We came to the conclusion that this was acceptable in the cases we wanted to compare the distribution of different cuisines; after all, we had no way to tell which cuisine or category is predominant for each restaurant, and when grouping by a specific category we wanted all the respective restaurant to be represented. On the other hand, we decided to remove duplicate businesses when category was not taken into consideration.

###Neighborhood information is missing


```{r}
library(extracat)

# reading in restaurants in Toronto file
restaurants_in_Toronto <- read_csv("C:/Users/Carlo/Desktop/EDAV Project/restaurants in Toronto.csv")

# reading in cuisine categories from text file
cuisine_cat <- read.delim("C:/Users/Carlo/Desktop/EDAV Project/Cat_List_cuisines_only.txt", header = TRUE)

# subset restaurants dataset by categories in text file
restaurants <- restaurants_in_Toronto %>% filter(category %in% cuisine_cat$Category)

# finding 20 most common cuisines
cuisine_counts <- restaurants %>% group_by(category) %>% summarise(count=n()) %>% arrange(-count) %>% top_n(20,count)

mostcommon20_cuisines <- unique(cuisine_counts$category)

# filtering out all cuisines except for 20 most common cuisines in Toronto for mapping and graphing
cuisines_toronto <- restaurants %>% filter(category %in% mostcommon20_cuisines)

cuisines_toronto_dedup <- cuisines_toronto[-13] %>% distinct()

visna(cuisines_toronto_dedup)
```

We notice that around 20% of businesses in Toronto were missing the variable "neighborhood", as the graph above shows.

```{r}
library(ggmap)
library(ggthemes)
# mapping neighborhood NA values

qmplot(longitude, latitude, data = cuisines_toronto_dedup, maptype = "toner-lite", color = ifelse(is.na(neighborhood), I("NA"), I("Not NA")), size=I(0.5), alpha=I(.5)) + ggtitle("Restaurants in Toronto")  + scale_color_colorblind() + theme(legend.title=element_blank())
```

Upon further inspection, we realized that the missing "neighborhood" values seem to be clustered in specific geographic location. Judging form the graph above, entire neighborhoods seem to be missing from the dataset. We concluded that the "neighborhood" variable was not reliable and we would need to rely on the latitude and longitude variables to represent the location of a business.
